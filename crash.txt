function getDepartments()
{
    $connect = dbconnect();
    $query = "SELECT d.dept_no, d.dept_name, COUNT(e.emp_no) as nb_employes 
              FROM departments d 
              LEFT JOIN dept_emp de ON d.dept_no = de.dept_no 
              LEFT JOIN employees e ON de.emp_no = e.emp_no 
              GROUP BY d.dept_no 
              ORDER BY d.dept_name";

    $result = mysqli_query($connect, $query);
    $departments = [];
    while ($row = mysqli_fetch_assoc($result)) {
        $departments[] = $row;
    }

    return $departments;
}
function getManager($id_dep)
{
    $connect = dbconnect();
    $query = "Select * from employees where emp_no =(SELECT emp_no FROM dept_manager where dept_no = '$id_dep' ORDER BY to_date DESC LIMIT 1)";
    $result = mysqli_query($connect, $query);
    $manager = mysqli_fetch_assoc($result);
    return $manager;
}

function getEmploye($id_dep)
{
    $connect = dbconnect();
    $query = "Select * from employees where emp_no in (SELECT emp_no FROM dept_emp where dept_no = '$id_dep')";
    $result = mysqli_query($connect, $query);
    $emp = [];
    while ($row = mysqli_fetch_assoc($result)) {
        $emp[] = $row;
    }

    return $emp;
}
function getEmployeeById($id)
{
    $connect = dbconnect();
    $query = "SELECT * FROM employees WHERE emp_no = '$id'";
    $result = mysqli_query($connect, $query);
    return mysqli_fetch_assoc($result);
}

function getSalaries($id)
{
    $connect = dbconnect();
    $query = "SELECT * FROM salaries WHERE emp_no = '$id' ORDER BY from_date DESC";
    $result = mysqli_query($connect, $query);
    $salaries = [];
    while ($row = mysqli_fetch_assoc($result)) {
        $salaries[] = $row;
    }
    return $salaries;
}

function getTitles($id)
{
    $connect = dbconnect();
    $query = "SELECT *, 
                CASE 
                    WHEN to_date = '9999-01-01' THEN DATEDIFF(CURDATE(), from_date)
                    ELSE DATEDIFF(to_date, from_date)
                END as duree_jours
              FROM titles 
              WHERE emp_no = '$id' 
              ORDER BY duree_jours DESC, from_date DESC";

    $result = mysqli_query($connect, $query);
    $titles = [];
    while ($row = mysqli_fetch_assoc($result)) {
        $titles[] = $row;
    }
    return $titles;
}

function searchEmployees($id_dep, $nom, $age_min, $age_max, $limit, $offset)
{
    $connect = dbconnect();
    $where = [];
    if ($id_dep) $where[] = "emp_no IN (SELECT emp_no FROM dept_emp WHERE dept_no = '$id_dep')";
    if ($nom) $where[] = "last_name LIKE '%" . mysqli_real_escape_string($connect, $nom) . "%'";
    if ($age_min) $where[] = "YEAR(CURDATE()) - YEAR(birth_date) >= " . intval($age_min);
    if ($age_max) $where[] = "YEAR(CURDATE()) - YEAR(birth_date) <= " . intval($age_max);
    $sql = "SELECT * FROM employees";
    if ($where) $sql .= " WHERE " . implode(' AND ', $where);
    $sql .= " ORDER BY emp_no LIMIT $offset, $limit";
    $result = mysqli_query($connect, $sql);
    $emp = [];
    while ($row = mysqli_fetch_assoc($result)) {
        $emp[] = $row;
    }
    return $emp;
}

function countEmployees($id_dep, $nom, $age_min, $age_max)
{
    $connect = dbconnect();
    $where = [];
    if ($id_dep) $where[] = "emp_no IN (SELECT emp_no FROM dept_emp WHERE dept_no = '$id_dep')";
    if ($nom) $where[] = "last_name LIKE '%" . mysqli_real_escape_string($connect, $nom) . "%'";
    if ($age_min) $where[] = "YEAR(CURDATE()) - YEAR(birth_date) >= " . intval($age_min);
    if ($age_max) $where[] = "YEAR(CURDATE()) - YEAR(birth_date) <= " . intval($age_max);
    $sql = "SELECT COUNT(*) as total FROM employees";
    if ($where) $sql .= " WHERE " . implode(' AND ', $where);
    $result = mysqli_query($connect, $sql);
    $row = mysqli_fetch_assoc($result);
    return $row['total'] ?? 0;
}
function verifdate($date)
{
    $query = "SELECT CURRENT_DATE()";
    $result = mysqli_query(dbconnect(), $query);
    $date_act = mysqli_fetch_assoc($result)['CURRENT_DATE()'];

    if ($date > $date_act) {
        return true;
    }
    return false;
}
function getStatistiques()
{
    $connect = dbconnect();
    $query = "SELECT 
                d.dept_name,
                COUNT(CASE WHEN e.gender = 'M' THEN 1 END) as nb_hommes,
                COUNT(CASE WHEN e.gender = 'F' THEN 1 END) as nb_femmes,
                COUNT(e.emp_no) as total_employes,
                ROUND(AVG(s.salary), 2) as salaire_moyen
              FROM departments d
              LEFT JOIN dept_emp de ON d.dept_no = de.dept_no
              LEFT JOIN employees e ON de.emp_no = e.emp_no
              LEFT JOIN salaries s ON e.emp_no = s.emp_no AND s.to_date = '9999-01-01'
              GROUP BY d.dept_no
              ORDER BY d.dept_name";

    $result = mysqli_query($connect, $query);
    $statistiques = [];
    while ($row = mysqli_fetch_assoc($result)) {
        $statistiques[] = $row;
    }
    return $statistiques;
}

function getDepAct($id)
{
    $query = "Select * from v_employees_departments_current where employee_no = '$id'";
    $result = mysqli_query(dbconnect(), $query);
    $depAct = [];
    while ($row = mysqli_fetch_assoc($result)) {
        $depAct[] = $row;
    }
    return $depAct;
}
function getdep_byID($id)
{
    $query = "Select * from departments where dept_no='$id' ";
    $result = mysqli_query(dbconnect(), $query);
    $dep = mysqli_fetch_assoc($result);
    return $dep;
}
// function updateEmployeeDepartment($id_emp, $dep_id, $date_debut,$dep_act) {
//     $connect = dbconnect();

//     $query1="UPDATE dept_emp SET to_date = '$date_debut' WHERE emp_no = '$id_emp' AND dept_no = '$dep_act'";
//     mysqli_query($connect, $query1);
//     $query = "INSERT INTO dept_emp (emp_no, dept_no, from_date,to_date) VALUES ('$id_emp', '$dep_id', '$date_debut', '9999-01-01')";
//     return mysqli_query($connect, $query);
// }



function updateEmployeeDepartment($id_emp, $dep_id, $date_debut, $dep_act)
{
    $connect = dbconnect();

    // Vérifier s'il existe déjà un enregistrement actif pour ce département
    $check_active = "SELECT * FROM dept_emp WHERE emp_no = '$id_emp' AND dept_no = '$dep_id' AND to_date = '9999-01-01'";
    $check_result = mysqli_query($connect, $check_active);

    if (mysqli_num_rows($check_result) > 0) {
        // L'employé est déjà actif dans ce département
        return false;
    }

    // Fermer l'ancien département actuel
    $query1 = "UPDATE dept_emp SET to_date = '$date_debut' WHERE emp_no = '$id_emp' AND dept_no = '$dep_act' AND to_date = '9999-01-01'";
    mysqli_query($connect, $query1);

    // Vérifier s'il existe un ancien enregistrement pour ce département
    $check_existing = "SELECT * FROM dept_emp WHERE emp_no = '$id_emp' AND dept_no = '$dep_id'";
    $existing_result = mysqli_query($connect, $check_existing);

    if (mysqli_num_rows($existing_result) > 0) {
        // Mettre à jour l'enregistrement existant
        $query = "UPDATE dept_emp SET from_date = '$date_debut', to_date = '9999-01-01' WHERE emp_no = '$id_emp' AND dept_no = '$dep_id'";
    } else {
        // Créer un nouvel enregistrement
        $query = "INSERT INTO dept_emp (emp_no, dept_no, from_date, to_date) VALUES ('$id_emp', '$dep_id', '$date_debut', '9999-01-01')";
    }

    return mysqli_query($connect, $query);
}
